default-job: &default-job
        docker:
            - image: docker:17.06.2-ce-git
        steps:
            - checkout
            - setup_remote_docker
            # TODO Avoid rebuild if nothing changes (Dockerfile, OS
            # updates, installed dependencies). Implement in general way:
            # `docker run -t cpdpro/baseimage:$CIRCLE_JOB check.$CIRCLE_JOB`
            - run:
                name: Generate cache key
                command:
                    cp Dockerfile.$CIRCLE_JOB /var/cache/key
            - restore_cache:
                key: "v3:{{ .Environment.CIRCLE_JOB }}:{{ checksum \"/var/cache/key\" }}"
                keys:
                    - "v3:{{ .Environment.CIRCLE_JOB }}:"
            - run:
                name: Load docker image layer cache
                command: |
                    docker load -i /var/cache/image.tar || true
            - run:
                name: docker build
                command: |
                    docker build \
                        --build-arg UPGRADE=$(date -Ihours) \
                        --cache-from cpdpro/baseimage:$CIRCLE_JOB \
                        -t cpdpro/baseimage:$CIRCLE_JOB \
                        -f Dockerfile.$CIRCLE_JOB \
                        .
                    if test "$CIRCLE_BUILD_NUM"; then # empty on local circleci
                        docker tag \
                            cpdpro/baseimage:$CIRCLE_JOB \
                            cpdpro/baseimage:$CIRCLE_JOB.$CIRCLE_BUILD_NUM
                    fi
            - run:
                name: Save docker image layer cache
                command: |
                    if test "$(sha256sum </var/cache/key)" != "$(sha256sum </var/cache/key.cached)"; then
                        docker save -o /var/cache/image.tar cpdpro/baseimage:$CIRCLE_JOB
                        cp /var/cache/key /var/cache/key.cached
                    fi
            - save_cache:
                key: "v3:{{ .Environment.CIRCLE_JOB }}:{{ checksum \"/var/cache/key\" }}"
                paths:
                    - /var/cache/image.tar
                    - /var/cache/key.cached
            - deploy:
                name: docker push
                command: |
                    if test "$CIRCLE_BRANCH" = "master" && test "$DOCKER_USER"; then
                        docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"
                        docker push cpdpro/baseimage:$CIRCLE_JOB
                        if test "$CIRCLE_BUILD_NUM"; then # empty on local circleci
                            docker push cpdpro/baseimage:$CIRCLE_JOB.$CIRCLE_BUILD_NUM
                        fi
                    fi

version: 2
jobs:
    base-narada4d:
        <<: *default-job
    build-golang:
        <<: *default-job
workflows:
    version: 2
    all:
        jobs:
            - base-narada4d
            - build-golang
